<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/public/style.css">
</head>

<body class="centered-page">
  <main class="card-container">

    <div class="auth-title" id="chatTitle">Chat Room</div>

    <div class="auth-grid" style="margin-bottom: 14px;">
      <div>
        <div class="auth-label">User</div>
        <input class="auth-input" id="who" readonly />
      </div>

      <div>
        <div class="auth-label">Room</div>
        <input class="auth-input" id="roomName" readonly />
      </div>
    </div>

    <div id="typing" class="auth-msg" style="margin-top:10px; color:#6c757d;"></div>

    <div id="chatBox" class="chat-box"></div>

    <div style="display:flex; gap:12px; margin-top:16px;">
      <input class="auth-input"
             id="messageInput"
             placeholder="Type your message..."
             style="flex:1;" />

      <button class="auth-btn"
              id="sendBtn"
              type="button"
              style="padding:14px 22px;">
        Send
      </button>
    </div>

    <div id="msg" class="auth-msg"></div>

    <div class="auth-btn-row" style="justify-content: space-between; margin-top: 18px;">
      <button class="auth-btn" id="leaveBtn" type="button" style="background:#6c757d;">
        Leave Room
      </button>
      <button class="auth-btn" id="logoutBtn" type="button" style="background:#dc3545;">
        Logout
      </button>
    </div>

  </main>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <script>
    const chatBox = document.getElementById("chatBox");
    const whoEl = document.getElementById("who");
    const roomEl = document.getElementById("roomName");
    const titleEl = document.getElementById("chatTitle");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const typingEl = document.getElementById("typing");

    // Session Check 
    const storedUser = localStorage.getItem("chatUser");
    const storedRoom = localStorage.getItem("chatRoom");

    if (!storedUser) {
      window.location.href = "/view/login.html";
    }

    if (!storedRoom) {
      window.location.href = "/view/room.html";
    }

    const user = JSON.parse(storedUser);
    const username = user.username;
    const room = storedRoom;

    whoEl.value = username;
    roomEl.value = room;
    titleEl.textContent = "Room: " + room;

    function addLine(text, isNotice = false) {
      const div = document.createElement("div");
      div.className = isNotice ? "chat-line notice" : "chat-line";
      div.textContent = text;

      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    //  Socket 
    const socket = io("http://localhost:3000");

    socket.on("connect", () => {
      console.log("Connected:", socket.id);
      socket.emit("joinRoom", { username, room });
    });

    // Notices
    socket.on("roomNotice", (data) => {
      if (data?.message) addLine("[Notice] " + data.message, true);
    });

    // Messages
    socket.on("roomMessage", (data) => {
      if (!data) return;
      addLine(`${data.username}: ${data.message}`);
    });

    // Typing indicator 
    socket.on("typing", (data) => {
      if (!data) return;

      if (data.isTyping) {
        typingEl.textContent = data.username + " is typing...";
      } else {
        typingEl.textContent = "";
      }
    });

    //  Typing Emit wait until sent 
    let isTyping = false;

    messageInput.addEventListener("input", () => {
      if (!isTyping) {
        isTyping = true;
        socket.emit("typing", { username, isTyping: true });
      }
    });

    //  Send Message 
    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;

      socket.emit("sendRoomMessage", {
        username,
        room,
        message: text
      });

      messageInput.value = "";

      // Stop typing ONLY when message is sent
      socket.emit("typing", { username, isTyping: false });
      isTyping = false;
      typingEl.textContent = "";
    }

    sendBtn.addEventListener("click", sendMessage);

    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });

    //  Leave Room 
    document.getElementById("leaveBtn").addEventListener("click", () => {
      socket.emit("leaveRoom", { username, room }, () => {
        localStorage.removeItem("chatRoom");
        window.location.href = "/view/room.html";
      });

      setTimeout(() => {
        localStorage.removeItem("chatRoom");
        window.location.href = "/view/room.html";
      }, 300);
    });

    // Logout 
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("chatUser");
      localStorage.removeItem("chatRoom");
      window.location.href = "/view/login.html";
    });
  </script>
</body>
</html>
